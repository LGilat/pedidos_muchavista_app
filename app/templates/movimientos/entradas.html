{% extends "base.html" %}
{% block title %}
    Registrar Entradas (Albarán)
{% endblock  title %}
{% block content %}
    <div class="container-fluid mt-3">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
            <h3 class="mb-0">Registrar Entradas (Albarán)</h3>
            <div class="d-flex gap-2">
                <a href="{{ url_for("productos.lista_productos") }}"
                   class="btn btn-secondary">Volver</a>
                <button type="button" id="resetAllBtn" class="btn btn-outline-danger">Poner todas a 0</button>
            </div>
        </div>
        <form method="post" id="formEntradas">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-2 mb-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">Número de albarán / referencia</label>
                    <input type="text"
                           name="referencia"
                           class="form-control"
                           placeholder="Ej: ALB-2025-001">
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Proveedor</label>
                    <select name="proveedor_id" class="form-control">
                        <option value="">-- Ninguno --</option>
                        {% for prov in proveedores %}<option value="{{ prov.id }}">{{ prov.nombre }}</option>{% endfor %}
                    </select>    
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="fecha" class="form-control">
                </div>
            </div>
            <!-- Tabla estilo "excel" con cabecera fija y tbody scrollable -->
            <div class="table-responsive" style="max-height:65vh; overflow:auto;">
                <table class="table table-bordered table-hover" id="tablaEntradas">
                    <thead class="table-light position-sticky" style="top:0; z-index:2;">
                        <tr>
                            <th style="min-width: 260px">Producto</th>
                            <th class="d-none d-md-table-cell" style="width:110px">Unidad</th>
                            <th style="width:140px">Cantidad recibida</th>
                            <th class="d-none d-md-table-cell" style="width:140px">Stock actual</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in productos %}
                            <tr data-product-id="{{ p.id }}" data-product-name="{{ p.nombre|e }}">
                                <td>
                                    <strong class="d-block d-md-inline">{{ p.nombre }}</strong>
                                    <input type="hidden" name="id[]" value="{{ p.id }}">
                                </td>
                                <td class="d-none d-md-table-cell align-middle">{{ p.unidad or '' }}</td>
                                <td>
                                    <input type="number"
                                           name="qty[]"
                                           step="1"
                                           min="0"
                                           value="0"
                                           class="form-control qty-input"
                                           style="max-width:140px">
                                </td>
                                <td class="d-none d-md-table-cell align-middle celda-stock" data-product-stock-actual={{ p.stock_actual }}>
                                    {{ "%.2f"|format(p.stock_actual) }}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3 d-flex justify-content-between align-items-center">
                <div class="text-muted">Rellena las cantidades recibidas y pulsa Guardar entradas.</div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">Guardar entradas</button>
                </div>
            </div>
        </form>
    </div>
    <!-- Inline JS: si usas externaliza a static/js/... -->
    <script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("formEntradas");
    const inputsQty = Array.from(document.querySelectorAll(".qty-input"));
    const resetBtn = document.getElementById("resetAllBtn");
    const searchBox = document.createElement("input");
    const celdas_stock_actual = document.querySelectorAll(".celda-stock"); 


    celdas_stock_actual.forEach(cell => {
        const stock = parseFloat(cell.dataset.productStockActual);
        if ( stock > 0){
            cell.style.backgroundColor = "rgba(0, 255, 0, 0.15)";
        }
        else if (stock === 0) {
            cell.style.backgroundColor = "rgba(255, 0, 0, 0.15) ";
        }
        else {
            cell.style.backgroundColor = "rgba(255, 255, 0, 0.15)";
        }
    })

    // Search box (insertado encima de la tabla, estilo compacto)
    searchBox.type = "search";
    searchBox.placeholder = "Buscar producto...";
    searchBox.className = "form-control mb-2";
    searchBox.style.maxWidth = "400px";
    const parent = document.querySelector(".table-responsive");
    parent.parentNode.insertBefore(searchBox, parent);

    // Filtrado en tiempo real
    searchBox.addEventListener("input", function() {
        const q = this.value.trim().toLowerCase();
        document.querySelectorAll("#tablaEntradas tbody tr").forEach(tr => {
            const name = (tr.dataset.productName || "").toLowerCase();
            tr.style.display = name.indexOf(q) !== -1 ? "" : "none";
        });
    });

    // Marcar filas con cantidad > 0
    function markRows() {
        inputsQty.forEach(input => {
            const tr = input.closest("tr");
            const val = parseFloat(input.value) || 0;
            if (val > 0) {
                tr.classList.add("table-success");
            } else {
                tr.classList.remove("table-success");
            }
        });
    }

    inputsQty.forEach(input => {
        input.addEventListener("input", markRows);
    });

    // Reset all
    resetBtn.addEventListener("click", function() {
        inputsQty.forEach(i => i.value = 0);
        markRows();
        searchBox.value = "";
        // scroll to top of container
        parent.scrollTop = 0;
    });

    // Submit: opcional - validación simple (evita envío si no hay cantidades > 0)
    form.addEventListener("submit", function(e) {
        const anyPositive = inputsQty.some(i => parseFloat(i.value) > 0);
        if (!anyPositive) {
            e.preventDefault();
            alert("No hay cantidades positivas. Introduce alguna cantidad antes de guardar.");
            return;
        }
        // Deja que el formulario se envíe normalmente
    });

    // marcar al cargar (si hay valores no 0 por defecto)
    markRows();
});
    </script>
{% endblock content %}
