{# app/templates/productos/list.html #}
{% extends "base.html" %}
{% block title %}
    Productos - Inventario
{% endblock title %}
{% block content %}
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
        <h3 class="mb-0">Productos</h3>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for("productos.nuevo_producto") }}"
               class="btn btn-success">+ Nuevo producto</a>
            <a href="#" class="btn btn-outline-primary">Ir al Inventario</a>
            <!-- BOTÓN PARA EXPORTAR PEDIDO -->
            <button type="submit"
                    form="pedidoForm"
                    class="btn btn-warning"
                    id="exportBtn">Exportar Pedido</button>
        </div>
    </div>
    <!-- FORM PARA EXPORTACIÓN -->
    <form id="pedidoForm"
          method="POST"
          action="{{ url_for("export.exportar_excel") }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-2 align-items-center">
                    <div class="col-12 col-md-4">
                        <input id="searchInput"
                               type="search"
                               class="form-control"
                               placeholder="Buscar por nombre, categoría o unidad...">
                    </div>
                    <div class="col-12 col-md-4">
                        <select id="categoriaFilter" class="form-select">
                            <option value="">Todas las categorías</option>
                            {% for cat in categorias %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-md-4 text-end text-muted">{{ productos|length }} productos</div>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="productosTable">
                <thead class="table-light">
                    <tr>
                        <th>Nombre</th>
                        <th class="d-none d-md-table-cell">Unidad</th>
                        <th>Cantidad</th>
                        <th>Categoría</th>
                        <th class="d-none d-md-table-cell">Ubicación</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                        <tr class="product-row"
                            data-category="{{ (p.categoria or '')|lower|trim }}">
                            <td class="align-middle">
                                {{ p.nombre }}
                                <input type="hidden" name="names[]" value="{{ p.nombre }}">
                            </td>
                            <td class="d-none d-md-table-cell align-middle">{{ p.unidad }}</td>
                            <!-- CANTIDAD + HIDDEN -->
                            <td class="align-middle">
                                <div class="qty-box">
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm qty-btn qty-minus"
                                            data-id="{{ p.id }}">–</button>
                                    <span class="qty-value" id="qty-{{ p.id }}">0</span>
                                    <button type="button"
                                            class="btn btn-outline-secondary btn-sm qty-btn qty-plus"
                                            data-id="{{ p.id }}">+</button>
                                </div>
                                <input type="hidden"
                                       name="qty_values[]"
                                       class="qty-hidden"
                                       id="qty-hidden-{{ p.id }}"
                                       value="0">
                            </td>
                            <td class="align-middle">
                                {{ p.categoria or '' }}
                                <input type="hidden" name="categories[]" value="{{ p.categoria }}">
                            </td>
                            <td class="d-none d-md-table-cell align-middle">
                                {{ p.ubicacion or '' }}
                                <input type="hidden" name="locations[]" value="{{ p.ubicacion }}">
                            </td>
                            <td class="text-end align-middle">
                                <div class="d-none d-md-inline-block">
                                    <a href="#" class="btn btn-sm btn-primary">Editar</a>
                                    <form method="POST"
                                          action="#"
                                          style="display:inline-block"
                                          onsubmit="return confirm('¿Eliminar {{ p.nombre }}?');">
                                        <button type="submit" class="btn btn-sm btn-danger">Borrar</button>
                                    </form>
                                </div>
                                <!-- Menú móvil -->
                                <div class="dropdown d-md-none">
                                    <button class="btn btn-secondary btn-sm dropdown-toggle"
                                            data-bs-toggle="dropdown">⋮</button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="#">Editar</a>
                                        </li>
                                        <li>
                                            <form method="POST"
                                                  action="#"
                                                  onsubmit="return confirm('¿Eliminar {{ p.nombre }}?');">
                                                <button type="submit" class="dropdown-item text-danger">Eliminar</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                No hay productos todavía.
                                <a href="{{ url_for("productos.nuevo_producto") }}">Crear uno</a>.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
    <!-- JS -->
    <script>
document.addEventListener("DOMContentLoaded", () => {

    // === FILTROS ===
    const inputSearch = document.getElementById('searchInput');
    const categoriaFilter = document.getElementById('categoriaFilter');
    const tableBody = document.querySelector('#productosTable tbody');

    function filtrar() {
    const q = inputSearch.value.toLowerCase();
    const cat = categoriaFilter.value.toLowerCase();

    Array.from(tableBody.rows).forEach(row => {
        const nombre = row.cells[0].textContent.toLowerCase();
        const categoria = row.dataset.category;  // <- siempre limpio

        const okSearch = nombre.includes(q);
        const okCat = !cat || categoria === cat;

        row.style.display = okSearch && okCat ? "" : "none";
    });
}


    inputSearch.addEventListener("input", filtrar);
    categoriaFilter.addEventListener("change", filtrar);

    // === STEPERS ===
    document.querySelectorAll(".qty-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const span = document.getElementById("qty-" + id);
            const hidden = document.getElementById("qty-hidden-" + id);

            let val = parseInt(span.textContent) || 0;

            if (btn.classList.contains("qty-plus")) val++;
            else if (val > 0) val--;

            span.textContent = val;
            hidden.value = val; // <-- se envía al Excel
        });
    });


    document.getElementById("exportBtn").addEventListener("click", function() {
        const hiddenInputs = document.querySelectorAll(".qty-hidden");
        const valueSpans = document.querySelectorAll(".qty-value");

        // Pequeño delay para permitir que se envíe el formulario
        setTimeout(() => {
            hiddenInputs.forEach(input => input.value = 0);
            valueSpans.forEach(span => span.textContent = 0);
        }, 50);
    });

});
    </script>
{% endblock %}
